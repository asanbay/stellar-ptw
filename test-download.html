<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —Å–∫–∞—á–∏–≤–∞–Ω–∏—è CSV</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px;
        }
        button:hover {
            background: #0052a3;
        }
        #log {
            background: #f5f5f5;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç —Å–∫–∞—á–∏–≤–∞–Ω–∏—è CSV —à–∞–±–ª–æ–Ω–∞</h1>
    
    <div>
        <button onclick="downloadTemplate()">üì• –°–∫–∞—á–∞—Ç—å —à–∞–±–ª–æ–Ω (–æ—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥)</button>
        <button onclick="downloadTemplateAlt()">üì• –°–∫–∞—á–∞—Ç—å —à–∞–±–ª–æ–Ω (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π)</button>
        <button onclick="clearLog()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
    </div>

    <div id="log"></div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function downloadTemplate() {
            try {
                log('üöÄ –ù–∞—á–∞–ª–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è (–æ—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥)...', 'info');
                
                const templateData = [
                    ['–ò–º—è / Ad / Name', '–î–æ–ª–∂–Ω–æ—Å—Ç—å / Pozisyon / Position', '–†–æ–ª—å / Rol / Role', 'Email', '–¢–µ–ª–µ—Ñ–æ–Ω / Telefon / Phone'],
                    ['–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á', '–î–∏—Ä–µ–∫—Ç–æ—Ä –ø–æ –û–¢ –∏ –ü–ë', 'issuer', 'ivanov@example.com', '+79991234567'],
                    ['Ahmet Yƒ±lmaz', '–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä', 'supervisor', 'ahmet@example.com', '+905551234567'],
                    ['–ü–µ—Ç—Ä–æ–≤ –ü–µ—Ç—Ä', '–ú–∞—Å—Ç–µ—Ä-–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å', 'foreman', 'petrov@example.com', '+79991234568'],
                    ['–°–∏–¥–æ—Ä–æ–≤ –°–µ—Ä–≥–µ–π', '–†–∞–±–æ—á–∏–π-–º–æ–Ω—Ç–∞–∂–Ω–∏–∫', 'worker', 'sidorov@example.com', '+79991234569'],
                    ['', '', '', '', ''],
                    ['–†–æ–ª–∏ / Roller / Roles:', '', '', '', ''],
                    ['issuer', '- –í—ã–¥–∞—é—â–∏–π –Ω–∞—Ä—è–¥ / ƒ∞zin Veren / Permit Issuer', '', '', ''],
                    ['supervisor', '- –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å / Sorumlu Y√∂netici / Supervisor', '', '', ''],
                    ['foreman', '- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å —Ä–∞–±–æ—Ç / ƒ∞≈ü Sorumlusu / Foreman', '', '', ''],
                    ['worker', '- –†–∞–±–æ—á–∏–π / ƒ∞≈ü√ßi / Worker', '', '', ''],
                ];

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
                const isWindowsLikeLocale = navigator.language.includes('ru') || 
                                             navigator.language.includes('tr') ||
                                             navigator.platform.includes('Win');
                const delimiter = isWindowsLikeLocale ? ';' : ',';
                
                log(`üìä –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: ${navigator.platform}`, 'info');
                log(`üåç –õ–æ–∫–∞–ª—å: ${navigator.language}`, 'info');
                log(`üîπ –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å: "${delimiter}"`, 'info');

                // –°–æ–∑–¥–∞–µ–º CSV —Å UTF-8 BOM
                const BOM = '\uFEFF';
                const csvContent = templateData.map(row => 
                    row.map(cell => {
                        if (cell.includes(delimiter) || cell.includes('"') || cell.includes('\n') || cell.includes('\r')) {
                            return `"${cell.replace(/"/g, '""')}"`;
                        }
                        return cell;
                    }).join(delimiter)
                ).join('\r\n');

                log(`üìÑ –†–∞–∑–º–µ—Ä CSV: ${csvContent.length} —Å–∏–º–≤–æ–ª–æ–≤`, 'info');

                // –°–æ–∑–¥–∞–µ–º Blob
                const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
                log(`üíæ –†–∞–∑–º–µ—Ä Blob: ${blob.size} –±–∞–π—Ç`, 'info');

                // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                const url = window.URL.createObjectURL(blob);
                log(`üîó Blob URL —Å–æ–∑–¥–∞–Ω: ${url.substring(0, 50)}...`, 'info');
                
                const link = document.createElement('a');
                link.href = url;
                link.download = 'personnel_template.csv';
                link.style.display = 'none';
                
                document.body.appendChild(link);
                log('‚ûï –°—Å—ã–ª–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ DOM', 'info');
                
                setTimeout(() => {
                    try {
                        link.click();
                        log('‚úÖ –ö–ª–∏–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω! –§–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–∫–∞—á–∞—Ç—å—Å—è.', 'success');
                        
                        setTimeout(() => {
                            document.body.removeChild(link);
                            window.URL.revokeObjectURL(url);
                            log('üßπ –û—á–∏—Å—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞', 'info');
                        }, 100);
                    } catch (error) {
                        log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ: ${error.message}`, 'error');
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(url);
                    }
                }, 0);
                
            } catch (error) {
                log(`‚ùå –û–®–ò–ë–ö–ê: ${error.message}`, 'error');
                console.error(error);
            }
        }

        function downloadTemplateAlt() {
            try {
                log('üöÄ –ù–∞—á–∞–ª–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥)...', 'info');
                
                const templateData = [
                    ['–ò–º—è', '–î–æ–ª–∂–Ω–æ—Å—Ç—å', '–†–æ–ª—å', 'Email', '–¢–µ–ª–µ—Ñ–æ–Ω'],
                    ['–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω', '–î–∏—Ä–µ–∫—Ç–æ—Ä', 'issuer', 'ivanov@example.com', '+79991234567'],
                    ['–ü–µ—Ç—Ä–æ–≤ –ü–µ—Ç—Ä', '–ú–∞—Å—Ç–µ—Ä', 'foreman', 'petrov@example.com', '+79991234568'],
                ];

                const delimiter = ';';
                const BOM = '\uFEFF';
                const csvContent = templateData.map(row => row.join(delimiter)).join('\r\n');

                // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ —á–µ—Ä–µ–∑ data URI
                const dataUri = 'data:text/csv;charset=utf-8,' + encodeURIComponent(BOM + csvContent);
                
                const link = document.createElement('a');
                link.href = dataUri;
                link.download = 'personnel_template_alt.csv';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                log('‚úÖ –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ data URI –≤—ã–ø–æ–ª–Ω–µ–Ω–æ!', 'success');
                
            } catch (error) {
                log(`‚ùå –û–®–ò–ë–ö–ê: ${error.message}`, 'error');
                console.error(error);
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ª–æ–≥ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            log('üåê –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
            log(`üñ•Ô∏è User Agent: ${navigator.userAgent}`, 'info');
            log(`üì± –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞: ${navigator.platform}`, 'info');
            log(`üåç –Ø–∑—ã–∫: ${navigator.language}`, 'info');
            log('', 'info');
            log('üëÜ –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è', 'info');
        });
    </script>
</body>
</html>
